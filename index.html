<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Les Rafah - Belajar Itu Seru!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- HTML2Canvas & JSPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        kid: {
                            blue: '#4CC9F0',
                            purple: '#7209B7',
                            pink: '#F72585',
                            yellow: '#FFD60A',
                            orange: '#FB5607',
                            paper: '#FFFDF5'
                        }
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #4CC9F0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.2) 2px, transparent 2px);
            background-size: 40px 40px;
            font-family: 'Nunito', sans-serif;
            overflow-x: hidden;
        }

        /* Dekorasi Awan */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            z-index: -1;
            opacity: 0.8;
        }
        .cloud::after, .cloud::before {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #F72585; border-radius: 10px; }

        /* Input Style yang lebih 'chunky' */
        .input-fun {
            transition: all 0.3s;
            border: 3px solid #e5e7eb;
        }
        .input-fun:focus {
            transform: scale(1.02);
            border-color: #4CC9F0;
            box-shadow: 0 4px 0 #4CC9F0; /* Efek 3D */
        }
        
        /* Tombol 3D */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 6px solid rgba(0,0,0,0.2);
        }
        .btn-3d:active {
            transform: translateY(4px);
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        /* Pola Kartu */
        .card-pattern {
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-color: #FFD60A;
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="pb-20 relative">

    <!-- Ornamen Background Melayang -->
    <div class="fixed top-10 left-[-20px] text-yellow-300 text-6xl animate-spin-slow opacity-50 pointer-events-none z-0"><i class="fa-solid fa-sun"></i></div>
    <div class="fixed bottom-20 right-[-20px] text-pink-300 text-6xl animate-float opacity-50 pointer-events-none z-0" style="animation-delay: 1s;"><i class="fa-solid fa-rocket"></i></div>
    <div class="fixed top-40 right-10 text-white text-4xl animate-pulse opacity-40 pointer-events-none z-0"><i class="fa-solid fa-star"></i></div>
    <div class="fixed top-1/2 left-5 text-green-300 text-5xl animate-float opacity-40 pointer-events-none z-0" style="animation-delay: 0.5s;"><i class="fa-solid fa-shapes"></i></div>

    <!-- Dekorasi Awan -->
    <div class="cloud w-32 h-12 top-5 left-10"></div>
    <div class="cloud w-48 h-16 top-20 right-5"></div>

    <!-- Navbar Mobile (Floating Island Style) -->
    <nav class="sticky top-4 z-50 px-4">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm rounded-full shadow-xl border-4 border-white flex justify-between items-center px-2 py-2">
            <div class="flex items-center space-x-3 pl-2">
                <div class="w-12 h-12 bg-kid-yellow rounded-full flex items-center justify-center text-kid-purple border-4 border-kid-purple shadow-sm animate-wiggle">
                    <i class="fa-solid fa-graduation-cap text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black font-display text-kid-purple tracking-wide">Les Rafah</h1>
                    <p class="text-[10px] font-bold text-gray-400 -mt-1">Sahabat Belajar Anak</p>
                </div>
            </div>
            <button onclick="toggleAdminPanel()" class="w-10 h-10 bg-gray-100 rounded-full text-gray-400 hover:text-kid-blue hover:bg-blue-50 transition-colors flex items-center justify-center">
                <i class="fa-solid fa-user-gear text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="max-w-md mx-auto px-4 mt-8 space-y-8 relative z-10">

        <!-- Hero Section -->
        <div id="homeSection" class="text-center space-y-4">
            <div class="relative inline-block">
                <div class="absolute inset-0 bg-kid-yellow rounded-full transform rotate-6 scale-110 opacity-50 blur-lg"></div>
                <div class="relative bg-white p-4 rounded-3xl shadow-lg border-b-8 border-gray-200 animate-float">
                    <span class="text-6xl">ðŸŽ’</span>
                </div>
                <!-- Badge 'New' -->
                <div class="absolute -top-2 -right-2 bg-kid-pink text-white text-xs font-bold px-2 py-1 rounded-full transform rotate-12 border-2 border-white">
                    Seru!
                </div>
            </div>
            
            <div class="bg-white/30 backdrop-blur-sm p-4 rounded-2xl border-2 border-white/50">
                <h2 class="text-3xl font-black font-display text-white drop-shadow-md tracking-wide">Ayo Belajar!</h2>
                <p class="text-white font-bold text-sm mt-1 text-shadow-sm">Daftarkan buah hati Anda untuk masa depan cerah & ceria bersama kami.</p>
            </div>
        </div>

        <!-- Form Pendaftaran -->
        <div id="formSection" class="bg-kid-paper p-1 rounded-[2.5rem] shadow-2xl relative">
            <!-- Hiasan Binder -->
            <div class="absolute -left-1 top-10 bottom-10 flex flex-col justify-between z-20">
                <div class="w-4 h-4 bg-gray-300 rounded-full border border-gray-400 shadow"></div>
                <div class="w-4 h-4 bg-gray-300 rounded-full border border-gray-400 shadow"></div>
                <div class="w-4 h-4 bg-gray-300 rounded-full border border-gray-400 shadow"></div>
                <div class="w-4 h-4 bg-gray-300 rounded-full border border-gray-400 shadow"></div>
            </div>

            <div class="bg-white border-4 border-kid-yellow p-6 rounded-[2rem] h-full">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-black font-display text-kid-purple inline-block border-b-4 border-kid-pink pb-1">
                        Formulir
                    </h3>
                </div>
                
                <form id="regForm" onsubmit="submitRegistration(event)" class="space-y-5">
                    
                    <!-- Nama Anak -->
                    <div class="group">
                        <label class="block text-sm font-black text-kid-blue mb-2 pl-2"><i class="fa-solid fa-child mr-2"></i>Nama Lengkap Anak</label>
                        <input type="text" name="namaAnak" required 
                            class="input-fun w-full bg-blue-50 rounded-2xl px-5 py-4 font-bold text-gray-700 placeholder-blue-300 focus:outline-none" 
                            placeholder="Contoh: Budi Santoso">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Tgl Lahir -->
                        <div>
                            <label class="block text-xs font-black text-kid-pink mb-2 pl-2"><i class="fa-solid fa-cake-candles mr-1"></i>Tgl Lahir</label>
                            <input type="date" name="tglLahir" required 
                                class="input-fun w-full bg-pink-50 rounded-2xl px-3 py-3 font-bold text-gray-600 focus:outline-none text-sm">
                        </div>
                        <!-- Tgl Gabung -->
                        <div>
                            <label class="block text-xs font-black text-kid-orange mb-2 pl-2"><i class="fa-solid fa-calendar-check mr-1"></i>Mulai Les</label>
                            <input type="date" name="tglGabung" id="tglGabungInput" required 
                                class="input-fun w-full bg-orange-50 rounded-2xl px-3 py-3 font-bold text-gray-600 focus:outline-none text-sm">
                        </div>
                    </div>

                    <!-- Alamat -->
                    <div>
                        <label class="block text-sm font-black text-green-500 mb-2 pl-2"><i class="fa-solid fa-map-location-dot mr-2"></i>Alamat Rumah</label>
                        <textarea name="alamat" required rows="2" 
                            class="input-fun w-full bg-green-50 rounded-2xl px-5 py-3 font-bold text-gray-700 placeholder-green-300 focus:outline-none" 
                            placeholder="Tulis alamat lengkap disini ya..."></textarea>
                    </div>

                    <!-- Ortu -->
                    <div>
                        <label class="block text-sm font-black text-purple-500 mb-2 pl-2"><i class="fa-solid fa-user-shield mr-2"></i>Nama Ayah / Ibu</label>
                        <input type="text" name="namaWali" required 
                            class="input-fun w-full bg-purple-50 rounded-2xl px-5 py-4 font-bold text-gray-700 placeholder-purple-300 focus:outline-none" 
                            placeholder="Nama Orang Tua">
                    </div>

                    <!-- HP -->
                    <div>
                        <label class="block text-sm font-black text-gray-500 mb-2 pl-2"><i class="fa-brands fa-whatsapp mr-2 text-green-500"></i>Nomor WhatsApp</label>
                        <input type="tel" name="noHp" required 
                            class="input-fun w-full bg-gray-50 rounded-2xl px-5 py-4 font-bold text-gray-700 placeholder-gray-300 focus:outline-none" 
                            placeholder="0812...">
                    </div>

                    <!-- Paket -->
                    <div class="relative">
                        <label class="block text-sm font-black text-kid-yellow mb-2 pl-2"><i class="fa-solid fa-book-open mr-2"></i>Mau Belajar Apa?</label>
                        <div class="relative">
                            <select name="paket" id="paketSelect" required 
                                class="input-fun w-full bg-yellow-50 rounded-2xl px-5 py-4 font-bold text-gray-700 focus:outline-none appearance-none cursor-pointer">
                                <option value="">Sedang memuat paket...</option>
                            </select>
                            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-kid-yellow">
                                <i class="fa-solid fa-chevron-down"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center font-bold bg-gray-100 rounded-full py-1">âœ¨ Pilih paket belajar yang disukai âœ¨</p>
                    </div>

                    <!-- Button Submit -->
                    <button type="submit" class="w-full btn-3d bg-kid-blue hover:bg-blue-400 text-white font-black font-display text-xl py-4 rounded-2xl shadow-lg mt-6 flex items-center justify-center group">
                        <span>Daftar Sekarang</span>
                        <i class="fa-solid fa-paper-plane ml-3 group-hover:translate-x-2 transition-transform"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Panel (Disembunyikan) -->
        <div id="adminPanel" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-xl border-4 border-gray-200">
                <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-dashed border-gray-200">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center text-white">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-gray-800">Admin Area</h3>
                            <p class="text-xs text-gray-400">Khusus Pengurus</p>
                        </div>
                    </div>
                    <button onclick="logoutAdmin()" class="bg-red-100 text-red-500 px-4 py-2 rounded-xl font-bold text-xs hover:bg-red-200 transition-colors">
                        <i class="fa-solid fa-right-from-bracket mr-1"></i> Keluar
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex space-x-3 mb-6 bg-gray-100 p-2 rounded-2xl">
                    <button onclick="switchTab('siswa')" id="tabBtnSiswa" class="flex-1 py-3 rounded-xl bg-white shadow-sm text-sm font-black text-kid-blue border-2 border-transparent">Siswa</button>
                    <button onclick="switchTab('paket')" id="tabBtnPaket" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-400 hover:bg-gray-200">Paket</button>
                </div>

                <!-- Tab: Siswa -->
                <div id="tabSiswa" class="block animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-gray-600"><i class="fa-solid fa-users mr-2"></i>Data Pendaftar</h4>
                        <button onclick="loadStudents()" class="text-kid-blue text-xs font-bold bg-blue-50 px-3 py-1 rounded-full"><i class="fa-solid fa-sync animate-spin-slow"></i> Refresh</button>
                    </div>
                    <div class="overflow-x-auto bg-gray-50 rounded-xl border-2 border-gray-100 p-2">
                        <table class="w-full text-xs text-left">
                            <thead class="text-gray-400 uppercase font-black text-[10px]">
                                <tr>
                                    <th class="px-2 py-2">ID</th>
                                    <th class="px-2 py-2">Nama</th>
                                    <th class="px-2 py-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="3" class="text-center py-4 font-bold text-gray-400">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Paket -->
                <div id="tabPaket" class="hidden animate-fade-in">
                    <form onsubmit="addPackage(event)" class="mb-6 bg-purple-50 p-4 rounded-2xl border-2 border-purple-100">
                        <h4 class="font-black text-purple-600 text-sm mb-3"><i class="fa-solid fa-plus-circle mr-2"></i>Tambah Paket Baru</h4>
                        <div class="space-y-3">
                            <input type="text" id="newPkgName" placeholder="Nama Program (Mis: Calistung)" class="w-full p-3 rounded-xl border-2 border-purple-100 text-xs font-bold focus:border-purple-300 outline-none" required>
                            <input type="text" id="newPkgPrice" placeholder="Harga (Mis: 50.000)" class="w-full p-3 rounded-xl border-2 border-purple-100 text-xs font-bold focus:border-purple-300 outline-none" required>
                            <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl text-xs font-black shadow-lg btn-3d">SIMPAN PAKET</button>
                        </div>
                    </form>
                    
                    <div class="overflow-x-auto bg-white rounded-xl border-2 border-gray-100">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase font-bold">
                                <tr>
                                    <th class="px-3 py-2">Program</th>
                                    <th class="px-3 py-2">Harga</th>
                                    <th class="px-3 py-2">Hapus</th>
                                </tr>
                            </thead>
                            <tbody id="packageTableBody" class="divide-y divide-gray-100">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Card Template (Re-styled for Kids) -->
    <div style="position: absolute; left: -9999px; top: 0;">
        <div id="cardTemplate" class="w-[350px] h-[220px] relative rounded-2xl overflow-hidden shadow-none font-sans text-white">
            <!-- Background -->
            <div class="absolute inset-0 bg-[#FFD60A]"></div>
            <!-- Pattern -->
            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#000 2px, transparent 2px); background-size: 15px 15px;"></div>
            
            <!-- Shapes Decoration -->
            <div class="absolute top-[-40px] right-[-40px] w-40 h-40 bg-[#4CC9F0] rounded-full border-4 border-white"></div>
            <div class="absolute bottom-[-20px] left-[-20px] w-32 h-32 bg-[#F72585] rounded-full border-4 border-white opacity-90"></div>
            
            <!-- Content -->
            <div class="relative z-10 p-5 flex flex-col h-full justify-between">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 bg-white/90 p-2 rounded-xl shadow-sm">
                        <div class="bg-blue-500 text-white font-black w-8 h-8 rounded-lg flex items-center justify-center border-2 border-white shadow">R</div>
                        <div>
                            <h2 class="text-sm font-black text-gray-800 leading-none">LES RAFAH</h2>
                            <p class="text-[8px] font-bold text-gray-500 tracking-wider">KARTU PELAJAR</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-black text-gray-700 bg-white/50 px-2 py-1 rounded-full mb-1">ID SISWA</p>
                        <p id="cardId" class="text-sm font-black text-white bg-black/20 px-3 py-1 rounded-lg border-2 border-white/30 tracking-widest font-mono">RFH-0000</p>
                    </div>
                </div>

                <!-- Main Info -->
                <div class="flex mt-3 bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/40">
                    <div class="flex-1">
                        <div class="mb-2">
                            <p class="text-[8px] text-gray-700 font-bold uppercase mb-0.5">Nama Siswa</p>
                            <h3 id="cardName" class="text-lg font-black text-gray-800 tracking-wide truncate max-w-[180px] font-display" style="text-shadow: 1px 1px 0px #fff;">Nama Siswa</h3>
                        </div>
                        <div class="flex space-x-2 mt-2">
                            <div class="bg-blue-500/90 px-2 py-1 rounded-lg">
                                <p class="text-[6px] text-white uppercase font-bold opacity-80">Program</p>
                                <p id="cardPackage" class="text-[10px] font-bold text-white">Matematika</p>
                            </div>
                            <div class="bg-pink-500/90 px-2 py-1 rounded-lg">
                                <p class="text-[6px] text-white uppercase font-bold opacity-80">Bergabung</p>
                                <p id="cardDate" class="text-[10px] font-bold text-white">01/01/24</p>
                            </div>
                        </div>
                    </div>
                    <!-- Right Icon/Avatar Placeholder -->
                    <div class="w-16 h-16 bg-white rounded-full border-4 border-[#4CC9F0] flex items-center justify-center shadow-md transform rotate-3">
                        <i class="fa-solid fa-face-smile text-4xl text-yellow-400"></i>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-1 flex justify-between items-center">
                    <p class="text-[8px] font-bold text-gray-700 italic bg-white/40 px-2 py-0.5 rounded-full">âœ¨ Rajin Pangkal Pandai âœ¨</p>
                    <div class="flex items-center space-x-1">
                         <div class="w-2 h-2 rounded-full bg-white border border-gray-400"></div>
                         <div class="w-2 h-2 rounded-full bg-white border border-gray-400"></div>
                         <div class="w-2 h-2 rounded-full bg-white border border-gray-400"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (Dibuat lebih lucu) -->
    <div id="loader" class="fixed inset-0 bg-[#4CC9F0] z-[100] flex items-center justify-center flex-col hidden">
        <div class="relative">
             <div class="w-20 h-20 bg-white rounded-full animate-bounce flex items-center justify-center shadow-lg">
                 <span class="text-4xl">ðŸš€</span>
             </div>
             <div class="w-20 h-4 bg-black/10 rounded-full mt-4 blur-sm animate-pulse mx-auto"></div>
        </div>
        <p class="text-white font-black text-xl mt-6 font-display tracking-widest animate-pulse">Tunggu ya...</p>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwdb7aIoJY-fQv9CPYYboHJKXg3G4_v-JFSEf60BxpP3T1V5fyPy_PLsymCtChsM92L/exec"; 

        // ==========================================
        // INIT
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tglGabungInput').valueAsDate = new Date();
            initApp();
        });

        async function initApp() {
            showLoader(true);
            try {
                // 1. Trigger Setup
                await fetch(`${WEB_APP_URL}?action=setup`);
                // 2. Load Data Paket
                loadPackages();
            } catch (error) {
                console.error("Init Error:", error);
                Swal.fire({
                    title: "Ups!", 
                    text: "Gagal menghubungi server. Coba reload ya.", 
                    icon: "error",
                    confirmButtonColor: '#F72585'
                });
            } finally {
                showLoader(false);
            }
        }

        // ==========================================
        // LOGIC PENDAFTARAN & KARTU
        // ==========================================
        async function loadPackages() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getPackages`);
                const json = await res.json();
                const select = document.getElementById('paketSelect');
                select.innerHTML = '<option value="">-- Pilih Paket Belajar --</option>';
                
                if(json.status === 'success') {
                    json.data.forEach(pkg => {
                        const opt = document.createElement('option');
                        opt.value = pkg['Nama Program'];
                        opt.textContent = `${pkg['Nama Program']} (Rp ${pkg['Harga']})`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function submitRegistration(e) {
            e.preventDefault();
            
            // Validasi sederhana
            const paket = document.getElementById('paketSelect').value;
            if(!paket) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Pilih Paket Dulu',
                    text: 'Adik mau belajar apa? Pilih dulu ya!',
                    confirmButtonColor: '#FFD60A',
                    confirmButtonText: 'Oke Siap!'
                });
                return;
            }

            showLoader(true);

            const formData = new FormData(e.target);
            const params = new URLSearchParams();
            params.append('action', 'register');
            for(const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: params
                });
                const result = await res.json();

                if(result.status === 'success') {
                    // Reset Form
                    e.target.reset();
                    document.getElementById('tglGabungInput').valueAsDate = new Date();
                    
                    // Generate Kartu
                    await generateAndDownloadCard(
                        result.data.nama,
                        result.data.id,
                        result.data.paket,
                        result.data.gabung
                    );

                    Swal.fire({
                        title: 'Hore Berhasil! ðŸŽ‰',
                        text: 'Pendaftaran sukses. Kartu siswa sedang didownload.',
                        icon: 'success',
                        confirmButtonText: 'Asyik!',
                        confirmButtonColor: '#4CC9F0',
                        background: '#fff url("https://www.transparenttextures.com/patterns/cubes.png")'
                    });
                } else {
                    Swal.fire('Yah Gagal...', result.message, 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Terjadi kesalahan koneksi', 'error');
            } finally {
                showLoader(false);
            }
        }

        async function generateAndDownloadCard(name, id, paket, date) {
            document.getElementById('cardName').textContent = name;
            document.getElementById('cardId').textContent = id;
            document.getElementById('cardPackage').textContent = paket;
            document.getElementById('cardDate').textContent = date;

            await new Promise(r => setTimeout(r, 500));
            const element = document.getElementById('cardTemplate');
            
            try {
                const canvas = await html2canvas(element, { scale: 3, useCORS: true, backgroundColor: null });
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: [85.6, 54]
                });

                doc.addImage(imgData, 'PNG', 0, 0, 85.6, 54);
                doc.save(`Kartu_Les_${name.replace(/\s+/g, '_')}.pdf`);

            } catch (err) {
                console.error("Gagal buat kartu:", err);
            }
        }

        // ==========================================
        // LOGIC ADMIN
        // ==========================================
        function toggleAdminPanel() {
            Swal.fire({
                title: 'Halo Admin!',
                text: 'Masukkan kode rahasia',
                input: 'password',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Buka Pintu',
                confirmButtonColor: '#7209B7',
                showLoaderOnConfirm: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value === '112211') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        document.getElementById('homeSection').classList.add('hidden');
                        document.getElementById('formSection').classList.add('hidden');
                        loadStudents(); 
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                        });
                        Toast.fire({ icon: 'success', title: 'Mode Admin Aktif' });
                    } else {
                        Swal.fire('Salah', 'Sandi salah!', 'error');
                    }
                }
            });
        }

        function logoutAdmin() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('homeSection').classList.remove('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        }

        function switchTab(tab) {
            if(tab === 'siswa') {
                document.getElementById('tabSiswa').classList.remove('hidden');
                document.getElementById('tabPaket').classList.add('hidden');
                document.getElementById('tabBtnSiswa').classList.replace('text-gray-400', 'text-kid-blue');
                document.getElementById('tabBtnSiswa').classList.replace('border-transparent', 'border-kid-blue');
                document.getElementById('tabBtnSiswa').classList.add('bg-white', 'shadow-sm');
                
                document.getElementById('tabBtnPaket').classList.replace('text-kid-blue', 'text-gray-400');
                document.getElementById('tabBtnPaket').classList.remove('bg-white', 'shadow-sm');
                loadStudents();
            } else {
                document.getElementById('tabSiswa').classList.add('hidden');
                document.getElementById('tabPaket').classList.remove('hidden');
                
                document.getElementById('tabBtnPaket').classList.replace('text-gray-400', 'text-kid-blue');
                document.getElementById('tabBtnPaket').classList.add('bg-white', 'shadow-sm');
                
                document.getElementById('tabBtnSiswa').classList.replace('text-kid-blue', 'text-gray-400');
                document.getElementById('tabBtnSiswa').classList.replace('border-kid-blue', 'border-transparent');
                document.getElementById('tabBtnSiswa').classList.remove('bg-white', 'shadow-sm');
                loadAdminPackages();
            }
        }

        // --- CRUD SISWA ---
        async function loadStudents() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-kid-blue"></i></td></tr>';
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getStudents`);
                const json = await res.json();
                tbody.innerHTML = '';

                if(json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400 text-xs">Belum ada murid nih</td></tr>';
                    return;
                }

                json.data.forEach(s => {
                    const tr = document.createElement('tr');
                    const tgl = s['Tanggal Gabung'] ? new Date(s['Tanggal Gabung']).toLocaleDateString('id-ID') : '-';
                    tr.className = "hover:bg-blue-50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-2 py-3 font-mono text-gray-500 font-bold">${s['ID Siswa']}</td>
                        <td class="px-2 py-3 font-bold text-gray-700">${s['Nama Anak']}</td>
                        <td class="px-2 py-3">
                            <button onclick="reprintCard('${s['Nama Anak']}', '${s['ID Siswa']}', '${s['Paket Les']}', '${tgl}')" class="bg-green-400 text-white px-3 py-1.5 rounded-lg shadow hover:bg-green-500 text-[10px] font-black btn-3d">
                                <i class="fa-solid fa-print"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        function reprintCard(nama, id, paket, tgl) {
            generateAndDownloadCard(nama, id, paket, tgl);
        }

        // --- CRUD PAKET ---
        async function loadAdminPackages() {
            const tbody = document.getElementById('packageTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-purple-500"></i></td></tr>';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getPackages`);
                const json = await res.json();
                tbody.innerHTML = '';
                
                json.data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-3 py-3 font-bold text-purple-900">${p['Nama Program']}</td>
                        <td class="px-3 py-3 text-gray-500 font-mono">${p['Harga']}</td>
                        <td class="px-3 py-3">
                            <button onclick="deletePackage('${p['ID Paket']}')" class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-lg">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function addPackage(e) {
            e.preventDefault();
            showLoader(true);
            const nama = document.getElementById('newPkgName').value;
            const harga = document.getElementById('newPkgPrice').value;

            const params = new URLSearchParams();
            params.append('action', 'addPackage');
            params.append('namaProgram', nama);
            params.append('harga', harga);
            params.append('keterangan', '-');

            await fetch(WEB_APP_URL, { method: 'POST', body: params });
            e.target.reset();
            showLoader(false);
            loadAdminPackages();
            loadPackages(); 
        }

        async function deletePackage(id) {
            Swal.fire({
                title: 'Hapus?',
                text: "Paket ini akan dihapus permanen",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoader(true);
                    const params = new URLSearchParams();
                    params.append('action', 'deletePackage');
                    params.append('idPaket', id);
                    
                    await fetch(WEB_APP_URL, { method: 'POST', body: params });
                    showLoader(false);
                    loadAdminPackages();
                    loadPackages();
                }
            })
        }

        function showLoader(show) {
            const loader = document.getElementById('loader');
            if(show) {
                loader.classList.remove('hidden');
                loader.classList.add('flex');
            } else {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }
    </script>
</body>
</html>
