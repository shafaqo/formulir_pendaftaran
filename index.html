<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Les Rafah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- HTML2Canvas & JSPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        rafah: {
                            blue: '#4ADE80',
                            yellow: '#FCD34D',
                            orange: '#FB923C',
                            primary: '#3B82F6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FEF3C7; } /* Kuning muda */
        .card-pattern {
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-color: #FBBF24;
            background-position: 0 0, 50px 50px;
            background-size: 20px 20px;
        }
        /* Loader Overlay */
        #loader { display: none; }
    </style>
</head>
<body class="text-gray-700 pb-20">

    <!-- Navbar Mobile -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 rounded-b-3xl">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl font-display">R</div>
                <h1 class="text-xl font-bold font-display text-blue-600">Les Rafah</h1>
            </div>
            <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-blue-500">
                <i class="fa-solid fa-user-gear text-xl"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="max-w-md mx-auto px-4 mt-6 space-y-6">

        <!-- Hero Section -->
        <div id="homeSection" class="text-center space-y-2">
            <div class="inline-block p-3 bg-white rounded-full shadow-md mb-2 animate-bounce">
                <span class="text-4xl">ðŸš€</span>
            </div>
            <h2 class="text-3xl font-bold font-display text-orange-500">Ayo Belajar!</h2>
            <p class="text-gray-600 text-sm">Daftarkan buah hati Anda untuk masa depan yang cerah bersama Les Rafah.</p>
        </div>

        <!-- Form Pendaftaran -->
        <div id="formSection" class="bg-white p-6 rounded-3xl shadow-xl border-b-8 border-blue-200">
            <h3 class="text-xl font-bold mb-4 text-blue-600 border-b pb-2"><i class="fa-solid fa-pen-to-square mr-2"></i>Formulir Pendaftaran</h3>
            
            <form id="regForm" onsubmit="submitRegistration(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Nama Anak</label>
                    <input type="text" name="namaAnak" required class="w-full bg-blue-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-400 outline-none" placeholder="Contoh: Budi Santoso">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">Tanggal Lahir</label>
                        <input type="date" name="tglLahir" required class="w-full bg-blue-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">Tgl Gabung</label>
                        <input type="date" name="tglGabung" id="tglGabungInput" required class="w-full bg-green-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-400 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Alamat Domisili</label>
                    <textarea name="alamat" required rows="2" class="w-full bg-blue-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-400 outline-none" placeholder="Alamat lengkap..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Nama Orang Tua/Wali</label>
                    <input type="text" name="namaWali" required class="w-full bg-yellow-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Nama Ayah/Ibu">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Nomor HP / WA</label>
                    <input type="tel" name="noHp" required class="w-full bg-yellow-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="0812...">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Pilih Program Paket</label>
                    <select name="paket" id="paketSelect" required class="w-full bg-purple-50 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-400 outline-none appearance-none">
                        <option value="">Memuat Paket...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">*Bisa diganti nanti</p>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition-all hover:shadow-xl mt-4">
                    <i class="fa-solid fa-paper-plane mr-2"></i> Daftar Sekarang
                </button>
            </form>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-xl border-b-8 border-purple-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-purple-600"><i class="fa-solid fa-lock mr-2"></i>Admin Area</h3>
                    <button onclick="logoutAdmin()" class="text-sm text-red-500 hover:underline">Keluar</button>
                </div>

                <!-- Tabs -->
                <div class="flex space-x-2 mb-4 bg-gray-100 p-1 rounded-lg">
                    <button onclick="switchTab('siswa')" id="tabBtnSiswa" class="flex-1 py-2 rounded-md bg-white shadow-sm text-sm font-bold text-gray-700">Data Siswa</button>
                    <button onclick="switchTab('paket')" id="tabBtnPaket" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200">Kelola Paket</button>
                </div>

                <!-- Tab: Siswa -->
                <div id="tabSiswa" class="block">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-sm">Daftar Pendaftar</h4>
                        <button onclick="loadStudents()" class="text-blue-500 text-xs"><i class="fa-solid fa-sync"></i> Refresh</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase font-bold">
                                <tr>
                                    <th class="px-2 py-2">ID</th>
                                    <th class="px-2 py-2">Nama</th>
                                    <th class="px-2 py-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-100">
                                <tr><td colspan="3" class="text-center py-2">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Paket -->
                <div id="tabPaket" class="hidden">
                    <form onsubmit="addPackage(event)" class="mb-4 bg-purple-50 p-3 rounded-xl">
                        <h4 class="font-bold text-xs mb-2">Tambah Paket Baru</h4>
                        <input type="text" id="newPkgName" placeholder="Nama Program" class="w-full mb-2 p-2 rounded border border-purple-200 text-xs" required>
                        <input type="text" id="newPkgPrice" placeholder="Harga" class="w-full mb-2 p-2 rounded border border-purple-200 text-xs" required>
                        <button type="submit" class="w-full bg-purple-500 text-white py-1 rounded text-xs font-bold">Simpan</button>
                    </form>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase font-bold">
                                <tr>
                                    <th class="px-2 py-2">Program</th>
                                    <th class="px-2 py-2">Harga</th>
                                    <th class="px-2 py-2">Hapus</th>
                                </tr>
                            </thead>
                            <tbody id="packageTableBody" class="divide-y divide-gray-100">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Card Template for Generation -->
    <div style="position: absolute; left: -9999px; top: 0;">
        <div id="cardTemplate" class="w-[350px] h-[220px] relative rounded-2xl overflow-hidden shadow-2xl font-sans text-white">
            <!-- Background -->
            <div class="absolute inset-0 bg-gradient-to-br from-blue-400 via-blue-500 to-purple-600"></div>
            <!-- Circles Decoration -->
            <div class="absolute top-[-20px] left-[-20px] w-24 h-24 bg-yellow-400 rounded-full opacity-50"></div>
            <div class="absolute bottom-[-10px] right-[-10px] w-32 h-32 bg-white opacity-10 rounded-full"></div>
            
            <!-- Content -->
            <div class="relative z-10 p-5 flex flex-col h-full justify-between">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="bg-white text-blue-600 font-bold w-8 h-8 rounded-full flex items-center justify-center border-2 border-yellow-400 shadow">R</div>
                        <div>
                            <h2 class="text-lg font-bold font-display leading-tight text-white drop-shadow-md">LES RAFAH</h2>
                            <p class="text-[8px] text-blue-100 tracking-wider">KARTU TANDA SISWA</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-mono text-blue-100">ID SISWA</p>
                        <p id="cardId" class="text-sm font-bold bg-white/20 px-2 py-0.5 rounded text-white border border-white/30">RFH-0000</p>
                    </div>
                </div>

                <!-- Main Info -->
                <div class="flex mt-2">
                    <div class="flex-1">
                        <div class="mb-2">
                            <p class="text-[9px] text-blue-100 uppercase">Nama Siswa</p>
                            <h3 id="cardName" class="text-xl font-bold text-white tracking-wide truncate max-w-[200px]" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">Nama Siswa</h3>
                        </div>
                        <div class="flex space-x-4">
                            <div>
                                <p class="text-[8px] text-blue-100 uppercase">Program</p>
                                <p id="cardPackage" class="text-xs font-semibold text-yellow-300">Matematika</p>
                            </div>
                            <div>
                                <p class="text-[8px] text-blue-100 uppercase">Bergabung</p>
                                <p id="cardDate" class="text-xs font-semibold">01/01/2024</p>
                            </div>
                        </div>
                    </div>
                    <!-- Right Icon/Avatar Placeholder -->
                    <div class="w-20 h-20 bg-white/20 rounded-xl border-2 border-dashed border-white/40 flex items-center justify-center">
                        <i class="fa-solid fa-graduation-cap text-4xl text-white/60"></i>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-2 pt-2 border-t border-white/20 flex justify-between items-end">
                    <p class="text-[8px] italic opacity-80">Mencerdaskan & Berakhlak Mulia</p>
                    <div class="flex items-center space-x-1">
                         <div class="w-2 h-2 rounded-full bg-red-400"></div>
                         <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                         <div class="w-2 h-2 rounded-full bg-green-400"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center flex-col">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p class="text-white font-bold animate-pulse">Memproses...</p>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwdb7aIoJY-fQv9CPYYboHJKXg3G4_v-JFSEf60BxpP3T1V5fyPy_PLsymCtChsM92L/exec"; 

        // ==========================================
        // INIT
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tglGabungInput').valueAsDate = new Date();
            initApp();
        });

        async function initApp() {
            showLoader(true);
            try {
                // 1. Trigger Setup (Buat Header Otomatis jika belum ada)
                await fetch(`${WEB_APP_URL}?action=setup`);
                
                // 2. Load Data Paket untuk Dropdown
                loadPackages();
            } catch (error) {
                console.error("Init Error:", error);
                Swal.fire("Error", "Gagal menghubungi server. Pastikan URL benar.", "error");
            } finally {
                showLoader(false);
            }
        }

        // ==========================================
        // LOGIC PENDAFTARAN & KARTU
        // ==========================================
        async function loadPackages() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getPackages`);
                const json = await res.json();
                const select = document.getElementById('paketSelect');
                select.innerHTML = '<option value="">-- Pilih Paket --</option>';
                
                if(json.status === 'success') {
                    json.data.forEach(pkg => {
                        const opt = document.createElement('option');
                        opt.value = pkg['Nama Program'];
                        opt.textContent = `${pkg['Nama Program']} - ${pkg['Harga']}`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function submitRegistration(e) {
            e.preventDefault();
            showLoader(true);

            const formData = new FormData(e.target);
            const params = new URLSearchParams();
            params.append('action', 'register');
            for(const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: params
                });
                const result = await res.json();

                if(result.status === 'success') {
                    // Reset Form
                    e.target.reset();
                    document.getElementById('tglGabungInput').valueAsDate = new Date();
                    
                    // Generate Kartu
                    await generateAndDownloadCard(
                        result.data.nama,
                        result.data.id,
                        result.data.paket,
                        result.data.gabung
                    );

                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'Pendaftaran sukses. Kartu siswa telah didownload.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire('Gagal', result.message, 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Terjadi kesalahan koneksi', 'error');
            } finally {
                showLoader(false);
            }
        }

        async function generateAndDownloadCard(name, id, paket, date) {
            // Isi Data ke Template Tersembunyi
            document.getElementById('cardName').textContent = name;
            document.getElementById('cardId').textContent = id;
            document.getElementById('cardPackage').textContent = paket;
            document.getElementById('cardDate').textContent = date;

            // Tunggu sebentar render DOM
            await new Promise(r => setTimeout(r, 500));

            const element = document.getElementById('cardTemplate');
            
            try {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                
                // Gunakan JSPDF untuk membuat PDF siap cetak
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: [85.6, 54] // Ukuran Kartu ID Standar (CR-80)
                });

                doc.addImage(imgData, 'PNG', 0, 0, 85.6, 54);
                doc.save(`Kartu_Siswa_${name.replace(/\s+/g, '_')}.pdf`);

            } catch (err) {
                console.error("Gagal buat kartu:", err);
                Swal.fire("Info", "Data tersimpan, tapi gagal membuat kartu otomatis. Silahkan minta admin mencetak ulang.", "warning");
            }
        }

        // ==========================================
        // LOGIC ADMIN
        // ==========================================
        function toggleAdminPanel() {
            Swal.fire({
                title: 'Masuk Admin',
                input: 'password',
                inputPlaceholder: 'Masukkan Sandi (112211)',
                showCancelButton: true,
                confirmButtonText: 'Masuk',
                confirmButtonColor: '#3B82F6'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value === '112211') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        document.getElementById('homeSection').classList.add('hidden');
                        document.getElementById('formSection').classList.add('hidden');
                        loadStudents(); // Load data awal
                        Swal.fire('Sukses', 'Mode Admin Aktif', 'success');
                    } else {
                        Swal.fire('Salah', 'Sandi salah!', 'error');
                    }
                }
            });
        }

        function logoutAdmin() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('homeSection').classList.remove('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        }

        function switchTab(tab) {
            if(tab === 'siswa') {
                document.getElementById('tabSiswa').classList.remove('hidden');
                document.getElementById('tabPaket').classList.add('hidden');
                document.getElementById('tabBtnSiswa').className = "flex-1 py-2 rounded-md bg-white shadow-sm text-sm font-bold text-gray-700";
                document.getElementById('tabBtnPaket').className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200";
                loadStudents();
            } else {
                document.getElementById('tabSiswa').classList.add('hidden');
                document.getElementById('tabPaket').classList.remove('hidden');
                document.getElementById('tabBtnSiswa').className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-gray-200";
                document.getElementById('tabBtnPaket').className = "flex-1 py-2 rounded-md bg-white shadow-sm text-sm font-bold text-gray-700";
                loadAdminPackages();
            }
        }

        // --- CRUD SISWA (ADMIN) ---
        async function loadStudents() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-2">Memuat...</td></tr>';
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getStudents`);
                const json = await res.json();
                tbody.innerHTML = '';

                if(json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-2 text-gray-400">Belum ada data</td></tr>';
                    return;
                }

                json.data.forEach(s => {
                    const tr = document.createElement('tr');
                    // Format tanggal sederhana
                    const tgl = s['Tanggal Gabung'] ? new Date(s['Tanggal Gabung']).toLocaleDateString('id-ID') : '-';
                    
                    tr.innerHTML = `
                        <td class="px-2 py-2 font-mono text-gray-500">${s['ID Siswa']}</td>
                        <td class="px-2 py-2 font-bold">${s['Nama Anak']}</td>
                        <td class="px-2 py-2">
                            <button onclick="reprintCard('${s['Nama Anak']}', '${s['ID Siswa']}', '${s['Paket Les']}', '${tgl}')" class="bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200 text-xs font-bold">
                                <i class="fa-solid fa-print"></i> Cetak
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
            }
        }

        function reprintCard(nama, id, paket, tgl) {
            generateAndDownloadCard(nama, id, paket, tgl);
        }

        // --- CRUD PAKET (ADMIN) ---
        async function loadAdminPackages() {
            const tbody = document.getElementById('packageTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-2">Memuat...</td></tr>';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getPackages`);
                const json = await res.json();
                tbody.innerHTML = '';
                
                json.data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-2 py-2 font-bold">${p['Nama Program']}</td>
                        <td class="px-2 py-2 text-gray-500">${p['Harga']}</td>
                        <td class="px-2 py-2">
                            <button onclick="deletePackage('${p['ID Paket']}')" class="text-red-500 hover:text-red-700">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function addPackage(e) {
            e.preventDefault();
            showLoader(true);
            const nama = document.getElementById('newPkgName').value;
            const harga = document.getElementById('newPkgPrice').value;

            const params = new URLSearchParams();
            params.append('action', 'addPackage');
            params.append('namaProgram', nama);
            params.append('harga', harga);
            params.append('keterangan', '-');

            await fetch(WEB_APP_URL, { method: 'POST', body: params });
            e.target.reset();
            showLoader(false);
            loadAdminPackages();
            loadPackages(); // Update dropdown di form utama juga
        }

        async function deletePackage(id) {
            if(!confirm('Hapus paket ini?')) return;
            showLoader(true);
            const params = new URLSearchParams();
            params.append('action', 'deletePackage');
            params.append('idPaket', id);
            
            await fetch(WEB_APP_URL, { method: 'POST', body: params });
            showLoader(false);
            loadAdminPackages();
            loadPackages();
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

    </script>
</body>
</html>
